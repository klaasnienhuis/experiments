<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sketchfab Map</title>
    <link rel="stylesheet" href="./styles/app.css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="./js/leaflet/leaflet.css" />
</head>

<body>
    <div class="app">
        <div class="sidebar">
            <div class="models">
                <div class="models-header">
                    Models tagged "meta_geo" <a href="./howto.html">(How to geotag your models)</a>
                </div>
                <ul>
                </ul>
                <div class="models-more">
                    <button>Load more</button>
                </div>
            </div>
            <div class="viewer">
            </div>
        </div>
        <div class="map__container">
            <div class="map__header">
                Double-click on the map to mark a location <button class="map__search">Find by coordinates</button>
            </div>
            <div class="map" id="map">
            </div>
        </div>
    </div>

<script src="./js/leaflet/leaflet.js"></script>
<script type="text/javascript" src="./js/latlon-geohash.js"></script>

<script>

const list = document.querySelector('.models');
const map = document.querySelector('.map');

const App = {
    map: null,
    markers: [],
};

const state = {
    models: [],
    next: null,
    currentModelUID: null
};

const newIcon = L.icon({
    iconUrl: './js/leaflet/images/marker-icon-green.png',
    iconRetinaUrl: './js/leaflet/images/marker-icon-green-2x.png',
    shadowUrl: './js/leaflet/images/marker-shadow.png',

    iconSize:     [25, 41],
    shadowSize:   [41, 41],
    iconAnchor:   [12, 41],
    shadowAnchor: [12, 41],
    popupAnchor:  [0, -41]
});

let tiles;
let markerLayer;
let newMarkerLayer;
let newMarker;

const initMap = () => {

    tiles = {
        map: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    	       attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        })
    };

    markerLayer = L.layerGroup();
    newMarkerLayer = L.layerGroup();

    const mymap = L.map('map', {
        layers: [
            tiles.satellite,
            tiles.map,
        ]
    }).setView([50, 0], 5);

    const baseMaps = {
        "Satellite": tiles.satellite,
        "Map": tiles.map,
    };

    const layerControl = L.control.layers(baseMaps, null, {
        collapsed: false
    });

    mymap.doubleClickZoom.disable();
    mymap.addControl(layerControl);
    mymap.addLayer(markerLayer);
    mymap.addLayer(newMarkerLayer);
    return mymap;
};

const getLatLon = (model) => {
    let longestHash = '';
    let currentTag;

    for (let i = 0; i < model.tags.length; i++) {
        currentTag = model.tags[i].name;
        if (currentTag.indexOf('geo_') === 0 && currentTag.length > longestHash.length && currentTag.length <= 16) {
            longestHash = currentTag.replace('geo_', '');
        }
    }

    if (longestHash !== '') {
        try {
            const latlon = Geohash.decode(longestHash);
            return latlon;
        } catch(e) {
            console.error(e.message, longestHash, model.uid);
        }
    } else {
        return false;
    }
};

const getModelByUid = (uid) => state.models.find(model => model.uid === uid);

const fetchModels = () => {
    const url = 'https://api.sketchfab.com/v3/models?sort_by=-createdAt&tags=meta_geo';
    fetch(url)
        .then(response => response.json())
        .then(data => onFetchSuccess(data));
};


const loadMore = () => {
    if (state.next) {
        const url = `https://api.sketchfab.com/v3/models?sort_by=-createdAt&tags=meta_geo&cursor=${state.next}`;
        fetch(url)
            .then(response => response.json())
            .then(data => onFetchSuccess(data));
    } else {
        alert('Nothing to load');
    }
};

const onFetchSuccess = (response) => {
    state.next = response.cursors.next;

    for (let model of response.results) {
        model.geo = getLatLon(model);
        if (model.geo) {
            state.models.push(model);
        }
    }

    if (!state.next) {
        document.querySelector('.models-more').style.display = 'none';
    } else {
        document.querySelector('.models-more').style.display = '';
    }

    renderModels();
    renderMarkers();
};

const renderMarker = (model) => {
    if (model.geo) {
        const marker = L.marker([model.geo.lat, model.geo.lon]);
        marker.on('click', () => selectModel(model.uid));
        marker.addTo(markerLayer);
        return marker;
    } else {
        return false;
    }
};

const renderMarkers = () => {
    App.markers = state.models.map(renderMarker);
};

const escapeHtml = (html) => {
    return html
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
 };

const renderModel = (model) => {
    const thumbnails = model.thumbnails.images.sort((a, b) => {
        if (a.width < b.width) return -1;
        if (a.width > b.width) return 1;
        return 0;
    });

    const thumbnailURL = thumbnails[1].url;

    return [
            `<li class="model" data-id="${model.uid}">`,
                `<a href="${model.viewerUrl}">`,
                    '<div class="model-image">',
                        `<img src="${thumbnailURL}" alt="" width="114" height="64">`,
                    '</div>',
                    '<div class="model-info">',
                        `<span class="model-name">${escapeHtml(model.name)}</span>`,
                        `<span class="model-author">by ${escapeHtml(model.user.displayName)}</span>`,
                    '</div>',
                '</a>',
            '</li>'
        ].join('');
};

const renderModels = () => {
    const modelList = state.models.map(renderModel);
    document.querySelector('.models ul').innerHTML = modelList.join('');
};

const selectModel = (uid) => {
    if (uid === state.currentModelUID) return;

    state.currentModelUID = uid;
    const model = getModelByUid(uid);

    if (model.geo) {
        App.map.panTo([model.geo.lat, model.geo.lon]);
    }

    const viewer = document.querySelector('.viewer');

    const html = [
        '<div class="viewer-info">',
            '<div class="viewer-header">',
                '<div><button class="back" title="Back"><img src="images/arrow-left-c.svg"> Back</button></div>',
                `<h1><a href="${model.viewerUrl}">${escapeHtml(model.name)}</a></h1>`,
                `<div class="viewer-meta">by ${escapeHtml(model.user.displayName)}</div>`,
            '</div>',
            '<div class="ratio16-9">',
                '<div class="ratio-inner">',
                    `<iframe src="${model.embedUrl}" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" onmousewheel=""></iframe>`,
                '</div>',
            '</div>',
            `<div class="viewer-description">${escapeHtml(model.description)}</div>`,
        '</div>'
    ].join('');

    viewer.classList.add('active');
    setTimeout(() => {
        viewer.innerHTML = html;
    }, 300);
};

const unselectModel = () => {
    state.currentModelUID = null;
    const viewer = document.querySelector('.viewer');
    viewer.classList.remove('active');
    setTimeout(() => {
        viewer.innerHTML = '';
    }, 500);
};

const setNewMarker = (lat, lon) => {
    const hash = Geohash.encode(lat, lon);
    const tag = `geo_${hash}`;

    const content = [
        'Coordinates:<br>',
        `${lat}, ${lon}<br>`,
        '<br>',
        '<b>How to add your model to this location</b><br>',
        'Add the following tags to your model info:<br>',
        '<code>meta_geo</code><br>',
        `<code>${tag}</code><br>`,
    ].join('');

    if (!newMarker) {
        newMarker = L.marker([lat, lon], {icon: newIcon});
        newMarker.addTo(newMarkerLayer);
        newMarker.bindPopup(content).openPopup();
    }

    if (newMarker) {
        newMarker.setLatLng(L.latLng(lat, lon));
        newMarker.getPopup().setContent(content);
        newMarker.openPopup();
    }

};

const init = () => {
    fetchModels();
    App.map = initMap();

    const delegateTargetNode = (e, elementSelector, handler) => {
        for (let target = e.target; target && target != this; target = target.parentNode) {
            if (target.matches(elementSelector)) {
                handler(target);
                break;
            }
        }
    };

    document.querySelector('.models ul').addEventListener('click', (e) => {
        e.preventDefault();
        delegateTargetNode(e, '.model', (target) => {
            const uid = target.getAttribute('data-id');
            selectModel(uid);
        });
    }, false);

    document.querySelector('.models-more button').addEventListener('click', (e) =>{
        e.preventDefault();
        loadMore();
    });

    document.querySelector('.viewer').addEventListener('click', (e) =>{
        e.preventDefault();
        delegateTargetNode(e, '.back', unselectModel);
    });

    document.querySelector('.map__search').addEventListener('click', (e) =>{
        e.preventDefault();
        const value = window.prompt('Enter coordinates (latitude and longitude separated by comma)');
        if (value) {
            const coordinates = value.split(',').map((value) => parseFloat(value));
            if (coordinates.length === 2) {
                setNewMarker(coordinates[0], coordinates[1]);
            }
        }
    });

    App.map.on('dblclick', (e) => setNewMarker(e.latlng.lat, e.latlng.lng));
};

init();

</script>
</body>
</html>
